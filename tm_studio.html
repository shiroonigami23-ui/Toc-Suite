<div class="app-container" id="tm-studio-container">
  <header class="header" style="background: linear-gradient(90deg, #10b981, #059669);">
    <h1>Turing Machine Studio</h1>
    <button id="tmPanelToggleBtn" class="panel-toggle-btn" style="margin-left: 10px;">
        <i data-lucide="menu"></i>
    </button>
    <div id="tmTapeHeader" style="margin-left: auto; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 8px; font-size: 0.9em;">
        Tape Head: <span id="currentHeadPos" style="font-weight: bold;">0</span>
    </div>
  </header>

  <main class="main-content">
    <aside id="controlPanel" class="control-panel">
      <details class="control-section" open>
        <summary><i data-lucide="sliders-horizontal"></i> Mode & Logic</summary>
        <div class="control-section-content">
           <div style="display:flex; flex-direction:column; gap:8px;">
             <div class="kv">
               <span>Machine Type:</span>
               <select id="tmModeSelect" style="flex:1; padding:4px; border-radius:4px; border:1px solid #ddd; font-size:0.85em;">
                 <option value="STANDARD">Standard Single-Tape</option>
                 <option value="MULTI_TAPE">Multi-Tape (k-Tape)</option>
                 <option value="STAY_OPTION">Stay-Option Variant</option>
                 <option value="NON_DET">Non-Deterministic (NTM)</option>
                 <option value="LBA">Linear Bounded (LBA)</option>
                 <option value="COPY_BLOCK">Block: Tape Copy</option>
                 <option value="INCREMENT_BLOCK">Block: Binary Incrementer</option>
                 <option value="PAL_CHECK_BLOCK">Block: Palindrome Check Skeleton</option>
               </select>
             </div>
             <div class="kv">
               <span>Blank Symbol:</span>
               <input id="tmBlankInput" value="B" maxlength="1" style="width:30px; text-align:center; border:1px solid #ddd; border-radius:4px;">
             </div>
           </div>
        </div>
      </details>

      <details class="control-section">
    <summary>
        <i data-lucide="brain-circuit" style="color: #10b981;"></i> 
        <span>Machine Intelligence</span>
    </summary>
    <div class="control-section-content" style="display: flex; flex-direction: column; gap: 12px;">
        
        <div class="intel-block">
            <div style="font-size: 0.75em; font-weight: bold; margin-bottom: 5px; color: #64748b; display: flex; align-items: center; gap: 5px;">
                <i data-lucide="columns" style="width: 12px; color: #10b981;"></i> INFINITE TAPE
            </div>
            <div id="tmTapeDisplay" class="tape-visualizer" style="display: flex; overflow-x: auto; gap: 4px; padding: 10px; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 8px; min-height: 52px;">
                </div>
        </div>

        <div class="intel-block">
            <div style="font-size: 0.75em; font-weight: bold; margin-bottom: 5px; color: #64748b; display: flex; align-items: center; gap: 5px;">
                <i data-lucide="info" style="width: 12px; color: #10b981;"></i> STATE ROLES
            </div>
            <div id="tmDynamicLegend" class="legend-flex" style="display: flex; flex-wrap: wrap; gap: 6px;">
                </div>
        </div>

        <button id="toggleLogicBtn" class="icon-btn" style="width: 100%; font-size: 0.8em; background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534;">
            <i data-lucide="table-2" style="width: 14px; color: #10b981;"></i> View Transition Table
        </button>
    </div>
</details>
<div id="logicTableModal" class="modal-overlay" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="modal-box" style="width: 85%; max-width: 900px; background: white; border-radius: 12px; padding: 25px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 10px; color: #064e3b;">
                <i data-lucide="table-2" style="color: #10b981;"></i> 
                Full Transition Logic
            </h3>
            
            <div style="display: flex; gap: 12px; align-items: center;">
                <button id="tmExportTableBtn" class="icon-btn" style="background: #ecfdf5; border: 1px solid #10b981; color: #065f46; font-size: 0.85em; padding: 6px 15px; border-radius: 8px; font-weight: 700; transition: all 0.2s;">
                    <i data-lucide="download" style="width: 16px;"></i> Export to Excel
                </button>
                
                <button id="closeLogicModal" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; color: #64748b; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                    <i data-lucide="x" style="width: 18px;"></i>
                </button>
            </div>
        </div>
        
        <div style="overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0;">
            <table class="logic-table" style="width: 100%; border-collapse: collapse; text-align: center; font-size: 0.9em;">
                <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0;">
                    <tr>
                        <th style="padding: 12px; color: #475569; font-weight: 700;">From State</th>
                        <th style="padding: 12px; color: #475569; font-weight: 700;">Read (σ)</th>
                        <th style="padding: 12px; color: #475569; font-weight: 700;">To State</th>
                        <th style="padding: 12px; color: #475569; font-weight: 700;">Write (γ)</th>
                        <th style="padding: 12px; color: #475569; font-weight: 700;">Move (D)</th>
                        <th style="padding: 12px; color: #475569; font-weight: 700; width: 60px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="tmLogicTableBody" style="color: #1e293b;">
                    </tbody>
            </table>
        </div>
    </div>
</div>
      <details class="control-section">
        <summary><i data-lucide="puzzle"></i> Practice</summary>
        <div class="control-section-content">
          <div style="display:flex; gap:8px; margin-bottom:8px;">
            <select id="tmPracticeLevel" style="flex:1; border-radius:4px; border:1px solid #ddd;">
              <option value="basic">Basic</option>
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
            </select>
            <button class="icon-btn" id="tmGenPracticeBtn">Generate</button>
          </div>
          <div id="practiceBox" style="margin-bottom:12px; min-height: 40px; font-size:0.85em;">No practice loaded.</div>
          <div style="display:flex; gap:8px;">
              <button class="icon-btn" id="tmCheckBtn" style="flex:1; background:var(--success); color:white;">Check</button>
              <button class="icon-btn" id="tmShowSolBtn" style="flex:1;">Solution</button>
          </div>
        </div>
      </details>
      <details class="control-section">
  <summary><i data-lucide="folder" style="color: #10b981;"></i> <span>File</span></summary>
  <div class="control-section-content">
    <div class="control-row">
      <button id="saveTmBtn" class="icon-btn tm-file-btn" title="Save current TM as JSON">
        <i data-lucide="save"></i> Save machine
      </button>
      <button id="loadTmBtn" class="icon-btn tm-file-btn" title="Load TM from JSON file">
        <i data-lucide="folder-open"></i> Load machine
      </button>
    </div>
    
    <button id="tmExportPngBtn" class="icon-btn tm-export-btn" style="width:100%; margin-top:4px; justify-content: center;">
      <i data-lucide="image"></i> Export Canvas (PNG)
    </button>
    
    <input type="file" id="tmLoadInput" accept=".json" style="display:none" />
  </div>
</details>

<style>
  .legend-flex { display: flex; gap: 10px; margin-bottom: 12px; }
  .legend-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; color: white; }
  .legend-badge.initial { background: #10b981; }
  .legend-badge.halt { background: #059669; border: 1px solid #ffffff; }
  .legend-badge.trap { background: #ef4444; }
  
  .table-scroll-wrapper { max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 6px; }
  .logic-table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
  .logic-table th { background: #f8fafc; position: sticky; top: 0; padding: 8px; text-align: left; }
  .logic-table td { padding: 8px; border-top: 1px solid #f1f5f9; }
  .symbol-cell { font-family: monospace; color: #10b981; font-weight: bold; }
  .move-badge { background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
  .table-del-btn { border: none; background: none; color: #ef4444; cursor: pointer; font-size: 1.2em; }
</style>
      <details class="control-section">
        <summary><i data-lucide="flask-conical"></i> Testing</summary>
        <div class="control-section-content">
          <div class="test-panel-v2" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px;">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
              <input id="tmTestInput" class="modal-input" placeholder="Tape input string..." style="flex:1;">
              <button id="tmRunTestBtn" class="icon-btn" style="background:var(--accent1); color:white;"><i data-lucide="play"></i></button>
            </div>
            
            <div id="tmManualControls" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
              <button id="tmStepBtn" class="icon-btn" style="font-size:0.8em;"><i data-lucide="step-forward"></i> Step</button>
              <button id="tmResetSimBtn" class="icon-btn" style="font-size:0.8em;"><i data-lucide="refresh-ccw"></i> Reset</button>
            </div>

            <div style="border-top: 1px solid #e2e8f0; padding-top: 10px;">
              <textarea id="tmBulkInput" placeholder="Bulk input (one per line)..." style="width:100%; height:60px; font-size:0.8em; border-radius:4px; padding:5px; border:1px solid #ddd;"></textarea>
              <button id="tmBulkRunBtn" class="icon-btn" style="width:100%; margin-top:5px; background:var(--accent2); color:white;">Bulk Test</button>
              <div id="tmBulkResults" style="margin-top:8px; max-height:100px; overflow-y:auto; font-size:0.75em;"></div>
            </div>
          </div>
        </div>
      </details>


      <details class="control-section">
        <summary><i data-lucide="library"></i> Library</summary>
        <div class="control-section-content">
          <div style="display:flex; gap:8px; margin-bottom:10px; align-items:center;">
            <input id="tmLibSearch" placeholder="Search TM..." style="flex:1; padding:8px; border-radius:4px; border:1px solid #ddd; font-size:0.85em;">
            <button id="tmLibRefresh" class="toolbar-icon" style="width:36px; height:36px; display:flex; align-items:center; justify-content:center;">
                <i data-lucide="refresh-cw" style="width:16px;"></i>
            </button>
          </div>
          <div id="tmLibraryList" style="max-height:200px; overflow-y:auto; border-top:1px solid #eee; padding-top:5px;">No entries.</div>
        </div>
      </details>

      <details class="control-section">
        <summary><i data-lucide="home"></i> Navigation</summary>
        <div class="control-section-content">
          <button id="tmBackToMenuBtn" class="icon-btn" style="width:100%;">
            <i data-lucide="arrow-left-circle"></i> Back to Main Menu
          </button>
        </div>
      </details>
    </aside>

    <div class="main-column">
  <section class="visualization-panel">
    <div class="canvas-wrapper">
      <div class="canvas-top">
        <div class="canvas-toolbar">
    <div class="toolbar-icon" data-mode="addclick" id="tm-tool-add" title="Add State">
        <i data-lucide="plus-circle" style="color: #10b981;"></i>
    </div>
    <div class="toolbar-icon active" data-mode="move" id="tm-tool-move" title="Move Tool">
        <i data-lucide="move" style="color: #6366f1;"></i> </div>
    <div class="toolbar-icon" data-mode="transition" id="tm-tool-trans" title="Add Transition">
        <i data-lucide="git-branch" style="color: #10b981;"></i>
    </div>
    <div class="toolbar-icon" data-mode="stateprops" id="tm-tool-props" title="State Properties">
        <i data-lucide="settings" style="color: #64748b;"></i>
    </div>
    <div class="toolbar-icon" data-mode="delete" id="tm-tool-del" title="Delete Tool">
        <i data-lucide="trash-2" style="color: #ef4444;"></i> </div>
    <div class="toolbar-icon" id="tm-tool-clear" title="Clear Canvas">
        <i data-lucide="file-x" style="color: #ef4444;"></i>
    </div>
          <button id="tmValidateBtn" class="toolbar-icon" title="Validate Machine" style="margin-left:8px"><i data-lucide="check-circle"></i></button>
          <div id="tmValidationLine" class="validation-box" style="margin-left:10px; font-size:0.75em; display:flex; align-items:center;"></div>

          <div id="tm-history-group" style="margin-left:auto; display:flex; gap:5px;">
            <button id="tmUndoBtn" class="toolbar-icon" title="Undo"><i data-lucide="undo-2"></i></button>
            <button id="tmRedoBtn" class="toolbar-icon" title="Redo"><i data-lucide="redo-2"></i></button>
          </div>
        </div>
      </div>
      <div class="canvas-area">
        <svg id="dfaSVG" viewBox="0 0 1400 900" style="background:#fff;">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                  <polygon points="0 0, 10 3.5, 0 7" fill="#10b981" />
                </marker>
            </defs>
            <g id="edges"></g>
            <g id="states"></g>
            <text id="canvasHint" x="700" y="450" text-anchor="middle" fill="#94a3b8" font-size="16">Select ➕ and tap to add a state</text>
        </svg>
      </div>
    </div>
    
    <div class="zoom-controls" style="position: absolute; right: 30px; top: 150px; z-index: 50;">
  <input id="tmZoomSlider" type="range" min="50" max="200" value="100" 
         style="writing-mode: vertical-lr; direction: rtl; width: 12px; height: 100px; cursor: pointer;" />
  <button id="tmZoomResetBtn" class="toolbar-icon" title="Reset Zoom" type="button">
      <i data-lucide="refresh-ccw"></i>
  </button>
</div>
  </section>
  <div id="stepLog">Simulation logs will appear here...</div>
  </div>
  </main>
</div>

<div id="tmTransitionModal" class="modal-overlay" style="display:none">
    <div class="modal-box">
        <h3>TM Transition: <span id="tmTransFromLabel"></span> → <span id="tmTransToLabel"></span></h3>
        
        <div id="tmStandardInputs" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div>
                <label style="font-size:0.8em;">Read</label>
                <input id="tmTransRead" class="modal-input" placeholder="0, 1, or B" maxlength="1">
            </div>
            <div>
                <label style="font-size:0.8em;">Write</label>
                <input id="tmTransWrite" class="modal-input" placeholder="New symbol" maxlength="1">
            </div>
            <div>
                <label style="font-size:0.8em;">Move</label>
                <select id="tmTransMove" class="modal-input">
                    <option value="L">L</option><option value="R">R</option><option value="S">S</option>
                </select>
            </div>
        </div>

        <div id="tmMultiTapeInputs"></div>

        <div class="modal-actions">
            <button id="tmTransCancel">Cancel</button>
            <button id="tmTransSave" class="primary-btn" style="background:#10b981;">Save Transition</button>
        </div>
    </div>
</div>

<div id="tmStatePropsModal" class="modal-overlay" style="display:none">
    <div class="modal-box">
        <h3>State Properties: <span id="tmPropStateName"></span></h3>
        <p class="modal-description">Turing Machines use a 'Halt' state for acceptance.</p>
        <div class="modal-prop-row">
            <label><input type="checkbox" id="tmPropInitial"> Initial State</label>
        </div>
        <div class="modal-prop-row">
            <label><input type="checkbox" id="tmPropHalt"> Halt (Accepting) State</label>
        </div>
        <div class="modal-actions">
            <button id="tmPropCancel">Cancel</button>
            <button id="tmPropSave" class="primary-btn" style="background:#10b981;">Save Changes</button>
        </div>
    </div>
</div>

<div id="tmConfirmClearModal" class="modal-overlay" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="modal-box" style="max-width: 400px; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
        <h3 style="color: #ef4444; margin-top: 0; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="alert-triangle"></i> Clear TM Canvas
        </h3>
        <p class="modal-description" style="color: #64748b; font-size: 0.9em; line-height: 1.5; margin: 15px 0;">
            Are you sure you want to delete all states and transitions?
        </p>
        <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button id="tmConfirmClearCancel" style="padding: 8px 16px; border-radius: 6px; border: 1px solid #e2e8f0; background: #f8fafc; color: #64748b; cursor: pointer; font-weight: 600;">
                Cancel
            </button>
            <button id="tmConfirmClearBtn" style="padding: 8px 16px; border-radius: 6px; border: none; background: #ef4444; color: white; cursor: pointer; font-weight: 600;">
                Clear Everything
            </button>
        </div>
    </div>
</div>

<div id="tmSaveModal" class="modal-overlay" style="display:none">
    <div class="modal-box" style="width: 400px; border-top: 4px solid #10b981;">
        <h3 style="color:#064e3b;"><i data-lucide="save"></i> Save TM Logic</h3>
        <div class="modal-prop-row" style="display: flex; align-items: center; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
            <span style="padding: 8px 12px; background: #e2e8f0; color: #475569; font-weight: bold; border-right: 1px solid #cbd5e1;">tm_</span>
            <input id="tmSaveNameInput" class="modal-input" placeholder="logic-name" style="border: none; flex: 1; padding: 8px; outline: none;">
        </div>
        <div class="modal-actions" style="margin-top:20px;">
            <button onclick="document.getElementById('tmSaveModal').style.display='none'">Cancel</button>
            <button id="tmSaveConfirmBtn" class="primary-btn" style="background:#10b981;">Confirm Save</button>
        </div>
    </div>
</div>

<div id="tmExportPngModal" class="modal-overlay" style="display:none">
    <div class="modal-box" style="width: 400px; border-top: 4px solid #059669;">
        <h3 style="color:#064e3b;"><i data-lucide="image"></i> Export Canvas PNG</h3>
        <div class="modal-prop-row" style="display: flex; align-items: center; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
            <span style="padding: 8px 12px; background: #e2e8f0; color: #475569; font-weight: bold; border-right: 1px solid #cbd5e1;">tm_</span>
            <input id="tmPngNameInput" class="modal-input" placeholder="visual-snapshot" style="border: none; flex: 1; padding: 8px; outline: none;">
        </div>
        <div class="modal-actions" style="margin-top:20px;">
            <button onclick="document.getElementById('tmExportPngModal').style.display='none'">Cancel</button>
            <button id="tmPngExportConfirm" class="primary-btn" style="background:#059669;">Download PNG</button>
        </div>
    </div>
</div>
