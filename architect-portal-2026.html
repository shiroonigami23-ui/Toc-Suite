<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Architect Portal | TOC-Suite Staging</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #6366f1; --emerald: #10b981; --slate-800: #1e293b; }
        body { background: #f8fafc; font-family: 'Inter', sans-serif; color: #334155; margin: 0; padding: 40px; }
        
        .glass-card { background: white; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; padding: 32px; }
        .stats-pill { background: #f1f5f9; padding: 4px 12px; border-radius: 999px; font-size: 0.85em; font-weight: 600; color: #64748b; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { padding: 16px; text-align: left; border-bottom: 2px solid #f1f5f9; color: #94a3b8; font-size: 0.75rem; letter-spacing: 0.05em; }
        td { padding: 16px; border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
        tr:hover td { background: #fcfdfe; }
        
        /* Interactive Elements */
        .search-box { padding: 10px 16px 10px 40px; border: 1px solid #e2e8f0; border-radius: 8px; width: 300px; outline: none; transition: 0.2s; }
        .search-box:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        
        .edit-area { font-family: 'Fira Code', 'Cascadia Code', monospace; width: 100%; height: 350px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; background: #0f172a; color: #e2e8f0; font-size: 13px; line-height: 1.5; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; background: #1e293b; color: white; display: none; z-index: 10001; box-shadow: 0 10px 15px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="toast" class="toast">Action completed successfully</div>

    <div id="loginOverlay" style="position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; width: 340px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
            <div style="background: #eef2ff; width: 64px; height: 64px; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i data-lucide="shield-check" style="color: #6366f1; width: 32px; height: 32px;"></i>
            </div>
            <h2 style="margin: 0 0 8px; color: #1e293b;">Architect Access</h2>
            <p style="color: #64748b; font-size: 0.9em; margin-bottom: 24px;">Confirm identity to manage staging.</p>
            <input type="password" id="adminCode" placeholder="Enter Secret Code" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 16px; box-sizing: border-box;">
            <button onclick="checkAccess()" style="width: 100%; background: #6366f1; color: white; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">Initialize Dashboard</button>
        </div>
    </div>

    <div id="dashboardContent" style="display: none;" class="glass-card">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
            <div>
                <h1 style="margin: 0; color: #0f172a; font-size: 1.75rem;">Staging Moderator <span id="pendingCount" class="stats-pill">0 Pending</span></h1>
                <p style="margin: 4px 0 0; color: #64748b; font-size: 0.9rem;">Reviewing student submissions before GitHub distribution.</p>
            </div>
            <button onclick="logout()" style="color: #ef4444; background: #fef2f2; border: 1px solid #fee2e2; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">Logout</button>
        </header>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: #f8fafc; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0;">
            <div style="display: flex; gap: 16px; align-items: center;">
                <input type="checkbox" id="selectAll" onclick="toggleAll(this)" style="width: 18px; height: 18px; cursor: pointer;">
                <div style="position: relative;">
                    <i data-lucide="search" style="position: absolute; left: 12px; top: 10px; width: 18px; color: #94a3b8;"></i>
                    <input type="text" id="searchTerm" oninput="filterRows()" placeholder="Search by name or type..." class="search-box">
                </div>
            </div>
            <button id="bulkPushBtn" onclick="pushSelected()" class="btn" style="background: var(--emerald); color: white; opacity: 0.5; pointer-events: none;">
                <i data-lucide="layers"></i> Push Selected (0)
            </button>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 40px;"></th>
                    <th>TYPE</th>
                    <th>IDENTIFIER / FILENAME</th>
                    <th>STAGED DATE</th>
                    <th style="text-align: right;">REVIEW</th>
                </tr>
            </thead>
            <tbody id="submissionRows"></tbody>
        </table>
    </div>

    <div id="reviewModal" class="modal-overlay" style="display:none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: white; padding: 32px; border-radius: 20px; width: 700px; max-width: 90vw; border-top: 6px solid var(--emerald);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1.5rem; color: #0f172a;">Review Machine</h3>
                <button onclick="prettifyJson()" class="btn" style="background: #f1f5f9; color: #475569; font-size: 0.8em; padding: 4px 10px;">
                    <i data-lucide="code" style="width: 14px;"></i> Prettify JSON
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display:block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">Target Filename</label>
                <div style="display: flex; align-items: center; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                    <span id="prefixLabel" style="padding: 12px; background: #e2e8f0; color: #475569; font-weight: 700;">pda_</span>
                    <input id="editName" style="background: transparent; border: none; padding: 12px; flex: 1; outline: none; font-weight: 600; color: #1e293b;">
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display:block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">Logic Definition</label>
                <textarea id="editJson" class="edit-area" spellcheck="false"></textarea>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="document.getElementById('reviewModal').style.display='none'" class="btn" style="background: transparent; color: #64748b;">Cancel</button>
                <button id="pushConfirmBtn" class="btn" style="background: var(--emerald); color: white; padding: 12px 24px;">Confirm & Commit to GitHub</button>
            </div>
        </div>
    </div>

    <script>
        let currentSubmissions = [];

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function checkAccess() {
            const code = document.getElementById('adminCode').value;
            if (code) {
                sessionStorage.setItem('architect_key', code);
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                fetchSubmissions();
            }
        }

        async function fetchSubmissions() {
            const res = await fetch('/.netlify/functions/get-submissions', {
                headers: { 'X-Architect-Key': sessionStorage.getItem('architect_key') }
            });
            if (!res.ok) { showToast("Invalid access key"); logout(); return; }
            
            currentSubmissions = await res.json();
            document.getElementById('pendingCount').textContent = `${currentSubmissions.length} Pending`;
            renderTable(currentSubmissions);
        }

        function renderTable(data) {
            document.getElementById('submissionRows').innerHTML = data.map((sub, idx) => `
                <tr>
                    <td style="text-align: center;"><input type="checkbox" class="sub-checker" value="${sub.id}" onclick="updateBulkButtonStyle()" style="cursor:pointer;"></td>
                    <td><span class="badge ${sub.type}" style="padding: 4px 10px; border-radius: 6px; font-size: 0.7em; font-weight: 800;">${sub.type}</span></td>
                    <td style="font-weight: 600; color: #1e293b;">${sub.name}</td>
                    <td style="color: #94a3b8; font-size: 0.85em;">${new Date(sub.created_at).toLocaleDateString()}</td>
                    <td style="text-align: right;">
                        <button onclick="openReview(${idx})" class="btn" style="background: #f8fafc; border: 1px solid #e2e8f0; color: #64748b; padding: 6px 12px; margin-left: auto;">
                            <i data-lucide="edit-3" style="width: 14px;"></i> Review
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            updateBulkButtonStyle();
        }

        function filterRows() {
            const q = document.getElementById('searchTerm').value.toLowerCase();
            const filtered = currentSubmissions.filter(s => s.name.toLowerCase().includes(q) || s.type.toLowerCase().includes(q));
            renderTable(filtered);
        }

        function toggleAll(master) {
            document.querySelectorAll('.sub-checker').forEach(cb => cb.checked = master.checked);
            updateBulkButtonStyle();
        }

        function updateBulkButtonStyle() {
            const count = document.querySelectorAll('.sub-checker:checked').length;
            const btn = document.getElementById('bulkPushBtn');
            btn.style.opacity = count > 0 ? "1" : "0.5";
            btn.style.pointerEvents = count > 0 ? "all" : "none";
            btn.innerHTML = `<i data-lucide="layers"></i> Push Selected (${count})`;
            lucide.createIcons();
        }

        function prettifyJson() {
            try {
                const raw = document.getElementById('editJson').value;
                document.getElementById('editJson').value = JSON.stringify(JSON.parse(raw), null, 4);
            } catch(e) { showToast("JSON Syntax Error"); }
        }

        function openReview(index) {
            const sub = currentSubmissions[index];
            document.getElementById('prefixLabel').textContent = sub.type.toLowerCase() + "_";
            document.getElementById('editName').value = sub.name;
            document.getElementById('editJson').value = JSON.stringify(sub.data, null, 4);
            document.getElementById('reviewModal').style.display = 'flex';
            document.getElementById('pushConfirmBtn').onclick = () => pushToLibrary(sub.id);
        }

        async function pushToLibrary(id) {
            const newName = document.getElementById('editName').value.trim();
            let newData;
            try { newData = JSON.parse(document.getElementById('editJson').value); } 
            catch(e) { showToast("JSON Error"); return; }

            const res = await fetch('/.netlify/functions/push-to-github', {
                method: 'POST',
                headers: { 'X-Architect-Key': sessionStorage.getItem('architect_key') },
                body: JSON.stringify({ id, editedName: newName, editedData: newData })
            });

            if (res.ok) {
                showToast("Machine Pushed to Library");
                document.getElementById('reviewModal').style.display = 'none';
                fetchSubmissions();
            }
        }

        async function pushSelected() {
            const ids = Array.from(document.querySelectorAll('.sub-checker:checked')).map(cb => parseInt(cb.value));
            if (!confirm(`Commit ${ids.length} machines to GitHub?`)) return;

            const res = await fetch('/.netlify/functions/push-to-github-bulk', {
                method: 'POST',
                headers: { 'X-Architect-Key': sessionStorage.getItem('architect_key') },
                body: JSON.stringify({ ids })
            });

            if (res.ok) { showToast("Bulk push successful!"); fetchSubmissions(); }
        }

        function logout() { sessionStorage.removeItem('architect_key'); location.reload(); }
        if (sessionStorage.getItem('architect_key')) checkAccess();
    </script>
</body>
</html>