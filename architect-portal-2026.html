<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TOC-Suite | Architect Staging</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body style="background: #f1f5f9; padding: 40px;">
    <div id="loginOverlay" style="position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center;">
            <h3 style="margin-top: 0;">Architect Access</h3>
            <input type="password" id="adminCode" placeholder="Enter Secret Code" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;">
            <button onclick="checkAccess()" style="width: 100%; background: #6366f1; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer;">Initialize Dashboard</button>
        </div>
    </div>

    <div id="dashboardContent" style="display: none; max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; padding: 30px;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px;">
            <h1 style="color: #0f172a; display: flex; align-items: center; gap: 10px;">
                <i data-lucide="shield-check" style="color: #6366f1;"></i> Staging Moderator
            </h1>
            <button onclick="logout()" style="font-size: 0.8em; color: #ef4444; background: none; border: 1px solid #ef4444; padding: 4px 8px; border-radius: 4px; cursor: pointer;">Logout</button>
        </header>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f8fafc; font-size: 0.85em; text-transform: uppercase;">
                    <tr>
                        <th style="padding: 12px;">Type</th>
                        <th style="padding: 12px;">Filename</th>
                        <th style="padding: 12px;">Date Staged</th>
                        <th style="padding: 12px; text-align: right;">Action</th>
                    </tr>
                </thead>
                <tbody id="submissionRows"></tbody>
            </table>
        </div>
    </div>

    <script>
        function checkAccess() {
            const code = document.getElementById('adminCode').value;
            if (code) {
                sessionStorage.setItem('architect_key', code);
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                fetchSubmissions();
            }
        }

        async function fetchSubmissions() {
            const res = await fetch('/.netlify/functions/get-submissions', {
                headers: { 'X-Architect-Key': sessionStorage.getItem('architect_key') }
            });
            if (!res.ok) { alert("Access Denied: Invalid Key"); logout(); return; }
            
            const data = await res.json();
            document.getElementById('submissionRows').innerHTML = data.map(sub => `
                <tr style="border-bottom: 1px solid #f1f5f9;">
                    <td style="padding: 15px;"><span class="badge ${sub.type}">${sub.type}</span></td>
                    <td style="padding: 15px; font-weight: 600;">${sub.name}</td>
                    <td style="padding: 15px; color: #64748b; font-size: 0.85em;">${new Date(sub.created_at).toLocaleDateString()}</td>
                    <td style="padding: 15px; text-align: right;">
                        <button onclick="pushToLibrary(${sub.id})" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            <i data-lucide="upload-cloud" style="width: 14px;"></i> Push to GitHub
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function pushToLibrary(id) {
            const res = await fetch('/.netlify/functions/push-to-github', {
                method: 'POST',
                headers: { 'X-Architect-Key': sessionStorage.getItem('architect_key') },
                body: JSON.stringify({ id })
            });
            if (res.ok) {
                alert("Successfully pushed to GitHub Library!");
                fetchSubmissions();
            }
        }

        function logout() { sessionStorage.removeItem('architect_key'); location.reload(); }
        if (sessionStorage.getItem('architect_key')) checkAccess();
    </script>
</body>
</html>