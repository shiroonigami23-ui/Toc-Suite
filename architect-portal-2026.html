<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Architect Portal | TOC-Suite Staging</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #6366f1; --emerald: #10b981; --slate-800: #1e293b; }
        body { background: #f8fafc; font-family: 'Inter', sans-serif; color: #334155; margin: 0; padding: 40px; }
        
        .glass-card { background: white; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; padding: 32px; }
        .stats-pill { background: #f1f5f9; padding: 4px 12px; border-radius: 999px; font-size: 0.85em; font-weight: 600; color: #64748b; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { padding: 16px; text-align: left; border-bottom: 2px solid #f1f5f9; color: #94a3b8; font-size: 0.75rem; letter-spacing: 0.05em; }
        td { padding: 16px; border-bottom: 1px solid #f1f5f9; transition: all 0.2s; }
        tr:hover td { background: #fcfdfe; }
        
        /* Interactive Elements */
        .search-box { padding: 10px 16px 10px 40px; border: 1px solid #e2e8f0; border-radius: 8px; width: 300px; outline: none; transition: 0.2s; }
        .search-box:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        
        .edit-area { font-family: 'Fira Code', 'Cascadia Code', monospace; width: 100%; height: 350px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; background: #0f172a; color: #e2e8f0; font-size: 13px; line-height: 1.5; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; background: #1e293b; color: white; display: none; z-index: 10001; box-shadow: 0 10px 15px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="toast" class="toast">Action completed successfully</div>

    <div id="loginOverlay" style="position: fixed; inset: 0; background: #0f172a; z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 20px; width: 340px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
            <div style="background: #eef2ff; width: 64px; height: 64px; border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i data-lucide="shield-check" style="color: #6366f1; width: 32px; height: 32px;"></i>
            </div>
            <h2 style="margin: 0 0 8px; color: #1e293b;">Architect Access</h2>
            <p style="color: #64748b; font-size: 0.9em; margin-bottom: 24px;">Confirm identity to manage staging.</p>
            <input type="password" id="adminCode" placeholder="Enter Secret Code" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 16px; box-sizing: border-box;">
            <button onclick="checkAccess()" style="width: 100%; background: #6366f1; color: white; padding: 12px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer;">Initialize Dashboard</button>
        </div>
    </div>

    <div id="dashboardContent" style="display: none;" class="glass-card">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
            <div>
                <h1 style="margin: 0; color: #0f172a; font-size: 1.75rem;">Staging Moderator <span id="pendingCount" class="stats-pill">0 Pending</span></h1>
                <p style="margin: 4px 0 0; color: #64748b; font-size: 0.9rem;">Reviewing student submissions before GitHub distribution.</p>
            </div>
            <button onclick="logout()" style="color: #ef4444; background: #fef2f2; border: 1px solid #fee2e2; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">Logout</button>
        </header>
        
        <div style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:16px;margin-bottom:20px;">
            <h3 style="margin:0 0 10px;color:#0f172a;">Assignment / Quiz Giver</h3>
            <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:8px;margin-bottom:8px;">
                <input id="asgTitle" placeholder="Assignment title" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;">
                <select id="asgMachineType" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;">
                    <option value="FA">FA</option>
                    <option value="MM">MM</option>
                    <option value="PDA">PDA</option>
                    <option value="TM">TM</option>
                    <option value="ALL">ALL</option>
                </select>
                <select id="asgMode" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;">
                    <option value="quiz">Quiz</option>
                    <option value="practice">Practice</option>
                </select>
                <input id="asgMarks" type="number" min="1" max="100" value="100" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                <input id="asgStartAt" type="datetime-local" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;">
                <input id="asgEndAt" type="datetime-local" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                <input id="asgMaxSubmissions" type="number" min="1" max="20" value="1" title="Max submissions per student" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;">
                <input id="asgArchiveDays" type="number" min="7" max="15" value="10" title="Archive pending submissions after end (days)" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;">
            </div>
            <div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:8px;">
                <label style="display:flex;gap:8px;align-items:center;color:#334155;font-size:0.9rem;">
                    <input id="asgRepoEligible" type="checkbox">
                    Special Hard Category (repo push allowed)
                </label>
                <label style="display:flex;gap:8px;align-items:center;color:#334155;font-size:0.9rem;">
                    <input id="asgStrictDeviceLock" type="checkbox" checked>
                    Strict device lock (1 roll + 1 email + 1 device)
                </label>
            </div>
            <textarea id="asgPrompt" placeholder="Question / prompt for students..." style="width:100%;min-height:80px;padding:10px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;"></textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                <button onclick="createAssignment()" class="btn" style="background:#6366f1;color:#fff;">Create Assignment</button>
                <div id="activeAssignmentHint" style="font-size:0.85em;color:#64748b;"></div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; background: #f8fafc; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0;">
            <div style="display: flex; gap: 16px; align-items: center;">
                <input type="checkbox" id="selectAll" onclick="toggleAll(this)" style="width: 18px; height: 18px; cursor: pointer;">
                <div style="position: relative;">
                    <i data-lucide="search" style="position: absolute; left: 12px; top: 10px; width: 18px; color: #94a3b8;"></i>
                    <input type="text" id="searchTerm" oninput="filterRows()" placeholder="Search by name or type..." class="search-box">
                </div>
                <select id="modeFilter" onchange="filterRows()" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;">
                    <option value="all">All Modes</option>
                    <option value="quiz">Quiz</option>
                    <option value="practice">Practice</option>
                </select>
                <select id="assignmentFilter" onchange="filterRows()" style="padding:10px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;min-width:220px;">
                    <option value="all">All Assignments</option>
                </select>
            </div>
            <div style="display:flex;gap:8px;">
                <button id="exportCsvBtn" onclick="exportFilteredCsv()" class="btn" style="background:#0f766e;color:#fff;">
                    <i data-lucide="download"></i> Export CSV
                </button>
                <button id="bulkPushBtn" onclick="pushSelected()" class="btn" style="background: var(--emerald); color: white; opacity: 0.5; pointer-events: none;">
                    <i data-lucide="layers"></i> Push Selected (0)
                </button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 40px;"></th>
                    <th>TYPE</th>
                    <th>IDENTIFIER / FILENAME</th>
                    <th>MODE / GRADE</th>
                    <th>STAGED DATE</th>
                    <th style="text-align: right;">REVIEW</th>
                </tr>
            </thead>
            <tbody id="submissionRows"></tbody>
        </table>
    </div>

    <div id="reviewModal" class="modal-overlay" style="display:none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: white; padding: 32px; border-radius: 20px; width: 700px; max-width: 90vw; border-top: 6px solid var(--emerald);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 1.5rem; color: #0f172a;">Review Machine</h3>
                <button onclick="prettifyJson()" class="btn" style="background: #f1f5f9; color: #475569; font-size: 0.8em; padding: 4px 10px;">
                    <i data-lucide="code" style="width: 14px;"></i> Prettify JSON
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display:block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">Target Filename</label>
                <div style="display: flex; align-items: center; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                    <span id="prefixLabel" style="padding: 12px; background: #e2e8f0; color: #475569; font-weight: 700;">pda_</span>
                    <input id="editName" style="background: transparent; border: none; padding: 12px; flex: 1; outline: none; font-weight: 600; color: #1e293b;">
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display:block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">Logic Definition</label>
                <textarea id="editJson" class="edit-area" spellcheck="false"></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 160px; gap: 10px; margin-bottom: 24px;">
                <div>
                    <label style="display:block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">Submission Mode</label>
                    <select id="submissionMode" style="width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;">
                        <option value="practice">Practice</option>
                        <option value="quiz">Quiz</option>
                    </select>
                </div>
                <div>
                    <label style="display:block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">Grade</label>
                    <input id="gradeInput" type="number" min="0" max="100" step="1" placeholder="0-100" style="width:100%;padding:10px 12px;border:1px solid #e2e8f0;border-radius:8px;box-sizing:border-box;">
                </div>
            </div>
            <div style="margin-bottom: 24px;">
                <label style="display:block; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">Reviewer Note</label>
                <textarea id="reviewNoteInput" placeholder="Optional note for student/admin..." style="width:100%;min-height:70px;padding:10px 12px;border:1px solid #e2e8f0;border-radius:8px;resize:vertical;box-sizing:border-box;"></textarea>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="document.getElementById('reviewModal').style.display='none'" class="btn" style="background: transparent; color: #64748b;">Cancel</button>
                <button id="saveReviewBtn" class="btn" style="background: #0ea5e9; color: white; padding: 12px 24px;">Save Review</button>
                <button id="pushConfirmBtn" class="btn" style="background: var(--emerald); color: white; padding: 12px 24px;">Confirm & Commit to GitHub</button>
            </div>
        </div>
    </div>

    <script>
        let currentSubmissions = [];
        let filteredSubmissions = [];

        function esc(v) {
            return String(v ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        function csvEscape(v) {
            const s = String(v ?? '');
            return `"${s.replace(/"/g, '""')}"`;
        }

        function toLocalDate(v) {
            if (!v) return '-';
            const d = new Date(v);
            return Number.isNaN(d.getTime()) ? '-' : d.toLocaleString();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function checkAccess() {
            const code = document.getElementById('adminCode').value;
            if (code) {
                sessionStorage.setItem('architect_key', code);
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                fetchSubmissions();
            }
        }

        async function fetchSubmissions() {
            const res = await fetch('/.netlify/functions/get-submissions', {
                headers: { 'X-Architect-Key': sessionStorage.getItem('architect_key') }
            });
            if (!res.ok) { showToast("Invalid access key"); logout(); return; }
            
            currentSubmissions = await res.json();
            document.getElementById('pendingCount').textContent = `${currentSubmissions.length} Pending`;
            rebuildAssignmentFilter();
            filterRows();
            refreshActiveAssignmentsHint();
        }

        function renderTable(data) {
            filteredSubmissions = data;
            document.getElementById('submissionRows').innerHTML = data.map((sub, idx) => `
                <tr>
                    <td style="text-align: center;"><input type="checkbox" class="sub-checker" value="${sub.id}" onclick="updateBulkButtonStyle()" style="cursor:pointer;"></td>
                    <td><span class="badge ${esc(sub.type)}" style="padding: 4px 10px; border-radius: 6px; font-size: 0.7em; font-weight: 800;">${esc(sub.type)}</span></td>
                    <td style="font-weight: 600; color: #1e293b;">
                        <div>${esc(sub.name)}</div>
                        <div style="font-size:0.78em;color:#64748b;">${esc(sub.assignment_title || 'No assignment')}</div>
                        <div style="font-size:0.75em;color:${sub.repo_eligible ? '#065f46' : '#64748b'};font-weight:${sub.repo_eligible ? '700' : '500'};">
                            ${sub.repo_eligible ? 'Repo-Eligible' : 'DB-Only'}
                        </div>
                    </td>
                    <td style="font-size: 0.85em; color: #475569;">
                        <div>${esc(sub.submission_mode || '-')}</div>
                        <div style="color:#0f766e;font-weight:700;">${(sub.grade ?? sub.grade === 0) ? `Grade: ${sub.grade}` : 'Ungraded'}</div>
                        <div style="color:${sub.suspicious_flag ? '#b91c1c' : '#64748b'};font-weight:${sub.suspicious_flag ? '700' : '500'};" title="${esc(sub.suspicious_reason || '')}">
                            ${sub.suspicious_flag ? 'Flagged' : 'Clean'}
                        </div>
                    </td>
                    <td style="color: #94a3b8; font-size: 0.85em;">${esc(toLocalDate(sub.created_at))}</td>
                    <td style="text-align: right;">
                        <button onclick="openReview(${Number(sub.id)})" class="btn" style="background: #f8fafc; border: 1px solid #e2e8f0; color: #64748b; padding: 6px 12px; margin-left: auto;">
                            <i data-lucide="edit-3" style="width: 14px;"></i> Review
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
            updateBulkButtonStyle();
        }

        function rebuildAssignmentFilter() {
            const sel = document.getElementById('assignmentFilter');
            if (!sel) return;
            const prev = sel.value || 'all';
            const titles = Array.from(new Set(currentSubmissions.map(s => (s.assignment_title || '').trim()).filter(Boolean))).sort((a, b) => a.localeCompare(b));
            sel.innerHTML = `<option value="all">All Assignments</option>${titles.map(t => `<option value="${encodeURIComponent(t)}">${esc(t)}</option>`).join('')}<option value="none">No Assignment</option>`;
            const hasPrev = Array.from(sel.options).some(o => o.value === prev);
            sel.value = hasPrev ? prev : 'all';
        }

        function filterRows() {
            const q = document.getElementById('searchTerm').value.toLowerCase();
            const mode = document.getElementById('modeFilter')?.value || 'all';
            const assignment = document.getElementById('assignmentFilter')?.value || 'all';
            const filtered = currentSubmissions.filter((s) => {
                const hitSearch = (s.name || '').toLowerCase().includes(q) || (s.type || '').toLowerCase().includes(q);
                const hitMode = mode === 'all' || (s.submission_mode || '').toLowerCase() === mode;
                let hitAssignment = true;
                if (assignment === 'none') hitAssignment = !(s.assignment_title || '').trim();
                else if (assignment !== 'all') hitAssignment = (s.assignment_title || '') === decodeURIComponent(assignment);
                return hitSearch && hitMode && hitAssignment;
            });
            renderTable(filtered);
        }

        function toggleAll(master) {
            document.querySelectorAll('.sub-checker').forEach(cb => cb.checked = master.checked);
            updateBulkButtonStyle();
        }

        function updateBulkButtonStyle() {
            const count = document.querySelectorAll('.sub-checker:checked').length;
            const btn = document.getElementById('bulkPushBtn');
            btn.style.opacity = count > 0 ? "1" : "0.5";
            btn.style.pointerEvents = count > 0 ? "all" : "none";
            btn.innerHTML = `<i data-lucide="layers"></i> Push Selected (${count})`;
            lucide.createIcons();
        }

        function prettifyJson() {
            try {
                const raw = document.getElementById('editJson').value;
                document.getElementById('editJson').value = JSON.stringify(JSON.parse(raw), null, 4);
            } catch(e) { showToast("JSON Syntax Error"); }
        }

        function openReview(index) {
            const sub = currentSubmissions.find((x) => Number(x.id) === Number(index));
            if (!sub) {
                showToast("Submission not found");
                return;
            }
            document.getElementById('prefixLabel').textContent = sub.type.toLowerCase() + "_";
            document.getElementById('editName').value = sub.name;
            document.getElementById('editJson').value = JSON.stringify(sub.data, null, 4);
            document.getElementById('submissionMode').value = sub.submission_mode || 'practice';
            document.getElementById('gradeInput').value = (sub.grade ?? '') === '' ? '' : sub.grade;
            document.getElementById('reviewNoteInput').value = sub.review_note || '';
            document.getElementById('reviewModal').style.display = 'flex';
            const pushBtn = document.getElementById('pushConfirmBtn');
            pushBtn.disabled = !sub.repo_eligible;
            pushBtn.style.opacity = sub.repo_eligible ? '1' : '0.5';
            pushBtn.style.pointerEvents = sub.repo_eligible ? 'auto' : 'none';
            pushBtn.textContent = sub.repo_eligible ? 'Confirm & Commit to GitHub' : 'DB-Only Submission';
            pushBtn.onclick = () => pushToLibrary(sub.id);
            document.getElementById('saveReviewBtn').onclick = () => saveReview(sub.id);
        }

        async function saveReview(id) {
            const mode = document.getElementById('submissionMode').value;
            const gradeRaw = document.getElementById('gradeInput').value.trim();
            const note = document.getElementById('reviewNoteInput').value.trim();
            const grade = gradeRaw === '' ? null : Number(gradeRaw);

            if (grade !== null && (Number.isNaN(grade) || grade < 0 || grade > 100)) {
                showToast("Grade must be between 0 and 100");
                return;
            }

            const res = await fetch('/.netlify/functions/save-review', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Architect-Key': sessionStorage.getItem('architect_key')
                },
                body: JSON.stringify({ id, submissionMode: mode, grade, reviewNote: note })
            });

            if (res.ok) {
                showToast("Review saved");
                fetchSubmissions();
            } else {
                const msg = await res.text();
                showToast(`Failed to save review: ${msg}`);
            }
        }

        async function pushToLibrary(id) {
            const newName = document.getElementById('editName').value.trim();
            let newData;
            try { newData = JSON.parse(document.getElementById('editJson').value); } 
            catch(e) { showToast("JSON Error"); return; }

            const res = await fetch('/.netlify/functions/push-to-github', {
                method: 'POST',
                headers: { 'X-Architect-Key': sessionStorage.getItem('architect_key') },
                body: JSON.stringify({ id, editedName: newName, editedData: newData })
            });

            if (res.ok) {
                showToast("Machine Pushed to Library");
                document.getElementById('reviewModal').style.display = 'none';
                fetchSubmissions();
            } else {
                const msg = await res.text();
                showToast(`Push blocked: ${msg}`);
            }
        }

        async function pushSelected() {
            const ids = Array.from(document.querySelectorAll('.sub-checker:checked')).map(cb => parseInt(cb.value, 10));
            if (!confirm(`Commit ${ids.length} machines to GitHub?`)) return;

            const res = await fetch('/.netlify/functions/push-to-github-bulk', {
                method: 'POST',
                headers: { 'X-Architect-Key': sessionStorage.getItem('architect_key') },
                body: JSON.stringify({ ids })
            });

            if (res.ok) {
                const out = await res.json().catch(() => []);
                const okCount = out.filter((x) => x.status === 'success').length;
                const failCount = out.length - okCount;
                showToast(`Bulk push: ${okCount} success, ${failCount} blocked/failed`);
                fetchSubmissions();
            } else {
                const msg = await res.text();
                showToast(`Bulk push failed: ${msg}`);
            }
        }

        function exportFilteredCsv() {
            const rows = filteredSubmissions || [];
            if (!rows.length) {
                showToast("No rows to export");
                return;
            }
            const header = [
                'id', 'name', 'type', 'submission_mode', 'assignment_id', 'assignment_title',
                'author', 'student_year', 'student_section', 'student_branch', 'student_roll',
                'grade', 'review_note', 'status', 'suspicious_flag', 'suspicious_reason', 'client_fingerprint', 'created_at'
            ];
            const lines = [header.join(',')];
            rows.forEach((r) => {
                lines.push([
                    csvEscape(r.id),
                    csvEscape(r.name),
                    csvEscape(r.type),
                    csvEscape(r.submission_mode),
                    csvEscape(r.assignment_id),
                    csvEscape(r.assignment_title),
                    csvEscape(r.author),
                    csvEscape(r.student_year),
                    csvEscape(r.student_section),
                    csvEscape(r.student_branch),
                    csvEscape(r.student_roll),
                    csvEscape(r.grade),
                    csvEscape(r.review_note),
                    csvEscape(r.status),
                    csvEscape(r.suspicious_flag),
                    csvEscape(r.suspicious_reason),
                    csvEscape(r.client_fingerprint),
                    csvEscape(r.created_at)
                ].join(','));
            });
            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `toc-gradebook-${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            showToast(`CSV exported (${rows.length} rows)`);
        }

        async function createAssignment() {
            const payload = {
                title: document.getElementById('asgTitle').value.trim(),
                machineType: document.getElementById('asgMachineType').value,
                assignmentMode: document.getElementById('asgMode').value,
                maxMarks: Number(document.getElementById('asgMarks').value || 100),
                startAt: document.getElementById('asgStartAt').value || null,
                endAt: document.getElementById('asgEndAt').value || null,
                maxSubmissions: Number(document.getElementById('asgMaxSubmissions').value || 1),
                archiveAfterDays: Number(document.getElementById('asgArchiveDays').value || 10),
                repoEligible: document.getElementById('asgRepoEligible').checked,
                strictDeviceLock: document.getElementById('asgStrictDeviceLock').checked,
                prompt: document.getElementById('asgPrompt').value.trim()
            };

            if (!payload.title || !payload.prompt) {
                showToast("Title and prompt are required.");
                return;
            }

            const res = await fetch('/.netlify/functions/create-assignment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Architect-Key': sessionStorage.getItem('architect_key')
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const msg = await res.text();
                showToast(`Failed: ${msg}`);
                return;
            }
            showToast("Assignment created.");
            document.getElementById('asgTitle').value = '';
            document.getElementById('asgPrompt').value = '';
            document.getElementById('asgMaxSubmissions').value = '1';
            document.getElementById('asgArchiveDays').value = '10';
            document.getElementById('asgRepoEligible').checked = false;
            document.getElementById('asgStrictDeviceLock').checked = true;
            refreshActiveAssignmentsHint();
        }

        async function refreshActiveAssignmentsHint() {
            const res = await fetch('/.netlify/functions/list-active-assignments?machineType=ALL');
            if (!res.ok) return;
            const list = await res.json();
            document.getElementById('activeAssignmentHint').textContent = `${list.length} active assignment(s)`;
        }

        function logout() { sessionStorage.removeItem('architect_key'); location.reload(); }
        if (sessionStorage.getItem('architect_key')) checkAccess();
    </script>
</body>
</html>
