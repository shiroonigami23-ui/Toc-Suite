name: Update README Summary

on:
  push:
    paths:
      - "automata/**"
      - "!README.md" # Prevent self-triggering loops

jobs:
  summary:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Generate Summary Table
        shell: python
        run: |
          import pathlib, re

          folders = {
              "Finite Automata": "automata/fa",
              "Pushdown Automata": "automata/pda",
              "Mealy/Moore": "automata/mm",
              "Turing Machines": "automata/tm"
          }

          rows = ["| Studio | Machine Count | Status |", "| :--- | :---: | :--- |"]
          for name, path in folders.items():
              p = pathlib.Path(path)
              count = len(list(p.glob("*.json"))) if p.exists() else 0
              rows.append(f"| {name} | **{count}** | Ready |")

          new_table = "\n".join(rows)
          readme_path = pathlib.Path("README.md")
          
          if not readme_path.exists():
              print("README.md missing, skipping...")
              exit(0)
              
          content = readme_path.read_text(encoding="utf-8")

          # --- CRITICAL FIX: Explicit Literal Tags ---
          start_tag = ""
          end_tag = ""
          
          # The regex now specifically looks for the tags and everything in between
          pattern = re.escape(start_tag) + r".*?" + re.escape(end_tag)
          replacement = f"{start_tag}\n{new_table}\n{end_tag}"
          
          if start_tag in content and end_tag in content:
              updated_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
              readme_path.write_text(updated_content, encoding="utf-8")
              print("README metrics updated successfully.")
          else:
              print("Placeholders not found in README.md. No update performed.")

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Docs: Updated Library Metrics in README" || echo "No changes"
          git push
