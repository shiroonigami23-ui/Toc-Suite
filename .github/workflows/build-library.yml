name: Build Automata Library

on:
  push:
    paths:
      - "automata/**"
      - "Data/**"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Sort Data and Merge Libraries
        run: |
          import json, pathlib
          
          def validate_structure(data):
              """Checks both root and nested 'machine' objects for validity."""
              # Extract the actual machine data (handles nested structure)
              m_data = data.get("machine", data)
              
              if not isinstance(m_data, dict): return False
              if "states" not in m_data or "transitions" not in m_data:
                  return False
              
              state_ids = {s["id"] for s in m_data["states"]}
              for t in m_data["transitions"]:
                  if t["from"] not in state_ids or t["to"] not in state_ids:
                      return False 
              return True

          type_to_folder = {
              "DFA": "automata/fa", "NFA": "automata/fa", "ENFA": "automata/fa",
              "PDA": "automata/pda",
              "MOORE": "automata/mm", "MEALY": "automata/mm",
              "TM": "automata/tm"
          }
          
          libraries = {
              "automata/fa": "library.json",
              "automata/pda": "pda_library.json",
              "automata/mm": "moore_mealy_library.json",
              "automata/tm": "tm_library.json"
          }

          # --- Step 1: Ingest and Sort from Data/ ---
          data_dir = pathlib.Path("Data")
          if data_dir.exists():
              for file in data_dir.glob("*.json"):
                  try:
                      # NEW LOGIC: Use the filename prefix first (tm_, pda_, fa_)
                      prefix = file.name.split('_')[0].upper()
                      
                      # Map the prefix to the correct directory
                      prefix_to_folder = {
                          "TM": "automata/tm",
                          "PDA": "automata/pda",
                          "FA": "automata/fa",
                          "MM": "automata/mm"
                      }
                      
                      # Fallback to internal content if no prefix is found
                      content = json.loads(file.read_text(encoding="utf-8"))
                      m_type = prefix if prefix in prefix_to_folder else (content.get("type") or "FA").upper()
                      target_folder = prefix_to_folder.get(m_type, "automata/fa")
                      
                      target_path = pathlib.Path(target_folder) / file.name
                      target_path.parent.mkdir(parents=True, exist_ok=True)
                      target_path.write_text(json.dumps(content, indent=2), encoding="utf-8")
                      
                      file.unlink()
                      print(f"Sorted {file.name} into {target_folder}")
                  except Exception as e:
                      print(f"Error processing {file.name}: {e}")

          # --- Step 2: Rebuild Libraries ---
          for folder, target in libraries.items():
              auto_dir = pathlib.Path(folder)
              if not auto_dir.exists(): continue
              
              unique_entries = {}
              for file in auto_dir.glob("*.json"):
                  try:
                      data = json.loads(file.read_text(encoding="utf-8"))
                      
                      # Validation now handles nested NFA/ENFA structures
                      if validate_structure(data):
                          key = data.get("id") or data.get("title")
                          if key:
                              unique_entries[key] = data
                      else:
                          print(f"CRITICAL ERROR: {file.name} has a broken structure and was EXCLUDED.")

                  except Exception as e:
                      print(f"Skipping {file.name}: {e}")
              
              pathlib.Path(target).write_text(
                  json.dumps(list(unique_entries.values()), indent=2), 
                  encoding="utf-8"
              )
              print(f"Updated {target} with {len(unique_entries)} unique entries")
        shell: python

      - name: Commit and push updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add automata/ *.json Data/
          git commit -m "Auto-sort Data and rebuild libraries (FA/NFA/ENFA Support)" || echo "No changes"
          git push
