<div class="app-container" id="pda-studio-container">
  <header class="header" style="background: linear-gradient(90deg, #667eea, #764ba2);">
    <h1>Pushdown Automata Studio</h1>
    <button id="pdaPanelToggleBtn" class="panel-toggle-btn" style="margin-left: 10px;">
        <i data-lucide="menu"></i>
    </button>
    <div id="pdaStackHeader" style="margin-left: auto; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 8px; font-size: 0.9em;">
        Stack Top: <span id="currentStackTop" style="font-weight: bold;">Z</span>
    </div>
  </header>

  <main class="main-content">
    <aside id="controlPanel" class="control-panel">
      <details class="control-section" open>
  <summary><i data-lucide="sliders-horizontal"></i> Mode & Logic</summary>
  <div class="control-section-content">
     <div style="display:flex; flex-direction:column; gap:8px;">
       <label style="font-size:0.8em; color:var(--muted);">Execution Mode:</label>
       <select id="pdaModeSelect" style="width:100%; padding:5px;">
         <option value="NPDA">Non-Deterministic (NPDA)</option>
         <option value="DPDA">Deterministic (DPDA)</option>
       </select>
       <div class="kv">Acceptance: <strong>Final State</strong></div>
     </div>
  </div>
</details>
      
<details class="control-section">
  <summary>
    <i data-lucide="brain-circuit" style="color: #10b981;"></i> 
    <span>Machine Intelligence</span>
  </summary>
  <div class="control-section-content" style="display: flex; flex-direction: column; gap: 12px;">
    
    <div class="intel-block">
      <div style="font-size: 0.75em; font-weight: bold; margin-bottom: 5px; color: #64748b; display: flex; align-items: center; gap: 5px;">
        <i data-lucide="layers" style="width: 12px; color: #10b981;"></i> LIVE STACK
      </div>
      <div id="pdaStackDisplay" class="stack-visualizer" style="display: flex; flex-direction: column-reverse; gap: 2px; padding: 10px; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 8px; min-height: 80px; max-height: 200px; overflow-y: auto;">
        <div class="stack-item initial" style="background: #10b981; color: white; text-align: center; padding: 4px; border-radius: 4px; font-weight: bold; font-family: monospace;">Z</div>
      </div>
    </div>

    <div class="intel-block">
      <div style="font-size: 0.75em; font-weight: bold; margin-bottom: 5px; color: #64748b; display: flex; align-items: center; gap: 5px;">
        <i data-lucide="info" style="width: 12px; color: #10b981;"></i> STATE ROLES
      </div>
      <div id="pdaDynamicLegend" class="legend-flex" style="display: flex; flex-wrap: wrap; gap: 6px;">
        </div>
    </div>

    <button id="togglePdaLogicBtn" class="icon-btn" style="width: 100%; font-size: 0.8em; background: #f0fdf4; border: 1px solid #bbf7d0; color: #166534; display: flex; align-items: center; justify-content: center; gap: 8px;">
      <i data-lucide="table-2" style="width: 14px; color: #10b981;"></i> View Transition Table
    </button>
  </div>
</details>
    
      <details class="control-section">
  <summary><i data-lucide="puzzle"></i> Practice</summary>
  <div class="control-section-content">
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <select id="pdaPracticeLevel" style="flex:1;">
        <option value="easy">Easy</option>
        <option value="basic">Basic</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>
      <button class="icon-btn" id="pdaGenPracticeBtn" style="white-space: nowrap;">Generate</button>
    </div>

    <div id="practiceBox" style="margin-bottom:12px; min-height: 40px;">No practice loaded.</div>
    
    <div style="display:flex; gap:8px;">
        <button class="icon-btn" id="pdaCheckBtn" style="flex:1; background:var(--success); color:white;">Check Answer</button>
        <button class="icon-btn" id="pdaShowSolBtn" style="flex:1;">Show Solution</button>
    </div>
  </div>
</details>
      <details class="control-section">
  <summary><i data-lucide="flask-conical"></i> Testing</summary>
  <div class="control-section-content">
    <div class="test-panel-v2" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px;">
      <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input id="pdaTestInput" class="modal-input" placeholder="Enter input..." style="flex:1; border-radius:4px;">
        <button id="pdaRandomTestBtn" class="icon-btn" title="Random String" style="background:var(--accent2); color:white; border-radius:4px;">
           <i data-lucide="dice-5" style="width:16px;"></i>
        </button>
        <button id="pdaRunTestBtn" class="icon-btn" style="background:var(--accent1); color:white; border-radius:4px;" title="Run Auto">
          <i data-lucide="play" style="width:16px;"></i>
        </button>
      </div>
      
      <div id="pdaManualControls" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:10px;">
        <button id="pdaStepBtn" class="icon-btn" style="font-size:0.8em;"><i data-lucide="step-forward" style="width:14px;"></i> Step</button>
        <button id="pdaResetSimBtn" class="icon-btn" style="font-size:0.8em;"><i data-lucide="refresh-ccw" style="width:14px;"></i> Reset</button>
      </div>

      <div class="test-status-area" style="border-top: 1px dashed #cbd5e1; padding-top: 8px; margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; font-size:0.75em; color:var(--muted); margin-bottom:4px;">
          <span>Status:</span>
          <span id="pdaTestOutput" style="font-weight:bold;">IDLE</span>
        </div>
        <div style="width:100%; height:4px; background:#e2e8f0; border-radius:2px; overflow:hidden;">
          <div id="pdaSimProgress" style="width:0%; height:100%; background:var(--accent1); transition:width 0.3s;"></div>
        </div>
      </div>

      <div style="border-top: 1px solid #e2e8f0; padding-top: 10px;">
        <label style="font-size:0.75em; font-weight:bold; color:var(--muted);">Bulk Testing (One per line):</label>
        <textarea id="pdaBulkInput" placeholder="abc&#10;aabb&#10;..." style="width:100%; height:80px; margin-top:5px; font-family:monospace; font-size:0.8em; padding:5px; border-radius:4px; border:1px solid #e2e8f0;"></textarea>
        <button id="pdaBulkRunBtn" class="icon-btn" style="width:100%; margin-top:5px; background:var(--accent2); color:white;">Run Bulk Test</button>
        <div id="pdaBulkResults" style="margin-top:8px; max-height:100px; overflow-y:auto; font-size:0.75em;"></div>
      </div>
    </div>
  </div>
</details>
      <details class="control-section">
  <summary><i data-lucide="folder"></i> File</summary>
  <div class="control-section-content">
    <div class="control-row">
      <button id="savePdaBtn" class="icon-btn" title="Save current PDA as JSON">
        <i data-lucide="save"></i> Save machine
      </button>
      <button id="loadPdaBtn" class="icon-btn" title="Load PDA from JSON file">
        <i data-lucide="folder-open"></i> Load machine
      </button>
    </div>
    
    <button id="pdaExportPngBtn" class="icon-btn" style="width:100%; margin-top:4px; justify-content: center;">
      <i data-lucide="image"></i> Export Canvas (PNG)
    </button>
    
    <input type="file" id="pdaLoadInput" accept=".json" style="display:none" />
  </div>
</details>
      <details class="control-section" id="pdaLibrarySection">
  <summary><i data-lucide="library"></i> Library</summary>
  <div class="control-section-content">
    <div style="display:flex; gap:8px; margin-bottom:10px; align-items:center;">
      <div style="position:relative; flex:1;">
        <input id="pdaLibSearch" placeholder="Search designs..." 
               style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e2e8f0; font-size:0.9em;">
      </div>
      <button id="pdaLibRefresh" class="toolbar-icon" title="Sync Library" style="width:36px; height:36px; flex-shrink:0;">
        <i data-lucide="refresh-cw" style="width:16px;"></i>
      </button>
    </div>

    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <select id="pdaLibFilter" style="flex:1; padding:6px; border-radius:6px; border:1px solid #e2e8f0; font-size:0.85em; background:#fff;">
        <option value="all">All Modes</option>
        <option value="NPDA">Non-Deterministic (NPDA)</option>
        <option value="DPDA">Deterministic (DPDA)</option>
      </select>
    </div>

    <div id="pdaLibraryList" 
         style="max-height: 320px; overflow-y: auto; border-top: 1px solid #edf2f7; padding-top: 8px; display: flex; flex-direction: column; gap: 8px;">
      <div class="library-message" style="text-align:center; padding:20px; color:var(--muted); font-size:0.9em;">
        <i data-lucide="loader" class="state-animating" style="display:block; margin:0 auto 8px; width:20px;"></i>
        Syncing with GitHub...
      </div>
    </div>
  </div>
</details>
      <details class="control-section" >
        <summary><i data-lucide="home"></i> Navigation</summary>
        <div class="control-section-content">
          <button id="pdaBackToMenuBtn" class="icon-btn" style="width:100%;">
            <i data-lucide="arrow-left-circle"></i> Back to Main Menu
          </button>
        </div>
      </details>
    </aside>

    <div class="main-column">
      <section class="visualization-panel">
        <div class="canvas-wrapper">
          <div class="canvas-toolbar">
           <div class="toolbar-icon" data-mode="addclick" id="pda-tool-add" title="Add State">
          <i data-lucide="plus-circle" style="color: #10b981;"></i>
        </div>
            <div class="toolbar-icon" data-mode="move" title="Move Tool">
          <i data-lucide="move" style="color: #6366f1;"></i>
        </div>
            <div class="toolbar-icon" data-mode="transition" title="Add Transition">
          <i data-lucide="git-branch" style="color: #10b981;"></i>
        </div>
            <div class="toolbar-icon" data-mode="rename" title="Rename State">
          <i data-lucide="edit-3" style="color: #64748b;"></i>
        </div>
            <div class="toolbar-icon" data-mode="stateprops" title="State Properties">
          <i data-lucide="settings" style="color: #64748b;"></i>
        </div>
           <div class="toolbar-icon" data-mode="delete" title="Delete Tool">
          <i data-lucide="trash-2" style="color: #ef4444;"></i>
        </div>
        <div class="toolbar-icon" id="pda-tool-clear" title="Clear Canvas">
          <i data-lucide="file-x" style="color: #ef4444;"></i>
        </div>
            
            <button id="validateBtn" class="toolbar-icon" title="Validate PDA"><i data-lucide="check-circle"></i></button>
            <div id="validationLine" class="validation-box"></div>
            
            <button id="undoBtn" class="toolbar-icon" style="margin-left:auto;" >
          <i data-lucide="undo-2" style="color: #94a3b8;"></i>
        </button>
        <button id="redoBtn" class="toolbar-icon" >
          <i data-lucide="redo-2" style="color: #94a3b8;"></i>
        </button>
          </div>

          <div class="canvas-area">
            <svg id="dfaSVG" viewBox="0 0 1400 900">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                      <polygon points="0 0, 10 3.5, 0 7" fill="#667eea" />
                    </marker>
                </defs>
                <g id="edges"></g>
                <g id="states"></g>
            </svg>
          </div>
        </div>
      </section>
      <div id="stepLog">Simulation logs will appear here...</div>
    </div>
  </main>
</div>

<div id="pdaRenameModal" class="modal-overlay" style="display:none">
    <div class="modal-box">
        <h3>Rename State</h3>
        <input id="pdaRenameInput" class="modal-input" placeholder="New Name" />
        <div class="modal-actions">
            <button onclick="document.getElementById('pdaRenameModal').style.display='none'">Cancel</button>
            <button id="pdaRenameSave" class="primary-btn">Save</button>
        </div>
    </div>
</div>

<div id="pdaStatePropsModal" class="modal-overlay" style="display:none">
    <div class="modal-box">
        <h3>State Properties</h3>
        <div class="modal-prop-row"><label><input type="checkbox" id="pdaPropInitial"> Initial State</label></div>
        <div class="modal-prop-row"><label><input type="checkbox" id="pdaPropFinal"> Final (Accepting) State</label></div>
        <div class="modal-actions">
            <button onclick="document.getElementById('pdaStatePropsModal').style.display='none'">Cancel</button>
            <button id="pdaPropSave" class="primary-btn">Save</button>
        </div>
    </div>
</div>
<div class="zoom-controls" style="position: absolute; right: 20px; top: 100px; z-index: 50; display: flex; flex-direction: column; align-items: center; gap: 10px;">
  <div style="display:flex; flex-direction:column; align-items:center;">
    <span style="font-size:10px; color:var(--muted); font-weight: bold;">ZOOM</span>
    <input id="pdaZoomSlider" type="range" min="50" max="200" value="100" 
           style="writing-mode: vertical-lr; direction: rtl; width: 12px; height: 150px; cursor: pointer;" />
  </div>

  <button id="pdaZoomResetBtn" class="toolbar-icon" title="Reset View">
      <i data-lucide="refresh-ccw"></i>
  </button>
</div>

<div id="pdaExportPngModal" class="modal-overlay" style="display:none">
    <div class="modal-box">
        <h3>Export as PNG</h3>
        <p class="modal-description">Enter a name for your PDA image file.</p>
        <input id="pdaPngNameInput" class="modal-input" placeholder="e.g., my-pda-design" />
        <div class="modal-actions">
            <button onclick="document.getElementById('pdaExportPngModal').style.display='none'">Cancel</button>
            <button id="pdaPngExportConfirm" class="primary-btn">Export</button>
        </div>
    </div>
</div>
<div id="pdaTransitionModal" class="modal-overlay" style="display:none">
    <div class="modal-box" style="width: 450px; border-top: 4px solid #6366f1;">
        <h3 style="margin-top:0; color:#312e81;">Add PDA Transition</h3>
        
        <div style="display:flex; justify-content: flex-end; margin-bottom: 10px;">
            <button id="pdaEpsilonShortcutBtn" class="icon-btn" style="font-size: 0.75em; padding: 4px 10px; background:#eef2ff; border:1px solid #6366f1; color:#3730a3;">
                <i data-lucide="zap" style="width:12px;"></i> Quick ε (All Fields)
            </button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
            <div class="modal-prop-row">
                <label style="font-size:0.75em; font-weight:bold; color:#64748b;">FROM STATE</label>
                <input id="pdaTransFrom" class="modal-input" readonly style="background:#f8fafc; font-weight:bold; text-align:center;">
            </div>
            <div class="modal-prop-row">
                <label style="font-size:0.75em; font-weight:bold; color:#64748b;">TO STATE</label>
                <input id="pdaTransTo" class="modal-input" readonly style="background:#f8fafc; font-weight:bold; text-align:center;">
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-bottom:20px;">
            <div class="modal-prop-row">
                <label style="font-size:0.8em; font-weight:bold;">INPUT (σ)</label>
                <input id="pdaTransSymbol" class="modal-input" placeholder="ε" maxlength="1" style="text-align:center; border-bottom:2px solid #10b981;">
            </div>
            <div class="modal-prop-row">
                <label style="font-size:0.8em; font-weight:bold;">STACK TOP (γ)</label>
                <input id="pdaTransPop" class="modal-input" placeholder="Z" maxlength="1" style="text-align:center; border-bottom:2px solid #6366f1;">
            </div>
            <div class="modal-prop-row">
                <label style="font-size:0.8em; font-weight:bold;">PUSH (λ)</label>
                <input id="pdaTransPush" class="modal-input" placeholder="AZ" style="text-align:center; border-bottom:2px solid #059669;">
            </div>
        </div>

        <div class="modal-actions" style="border-top: 1px solid #f1f5f9; padding-top:15px;">
            <button onclick="document.getElementById('pdaTransitionModal').style.display='none'" style="background:#f1f5f9; color:#475569;">Cancel</button>
            <button id="pdaTransSave" class="primary-btn" style="background:#6366f1; color:white; font-weight:bold;">Save Transition</button>
        </div>
    </div>
</div>

<div id="pdaConfirmClearModal" class="modal-overlay" style="display:none">
    <div class="modal-box">
        <h3>Clear Canvas</h3>
        <p class="modal-description">Are you sure you want to clear the entire PDA? This action can be undone.</p>
        <div class="modal-actions">
            <button onclick="document.getElementById('pdaConfirmClearModal').style.display='none'">Cancel</button>
            <button id="pdaConfirmClearBtn" class="danger-btn">Clear Canvas</button>
        </div>
    </div>
</div>

<div id="pdaLogicModal" class="modal-overlay" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div class="modal-box" style="width: 85%; max-width: 900px; background: white; border-radius: 12px; padding: 25px; max-height: 85vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px;">
      <h3 style="margin: 0; display: flex; align-items: center; gap: 8px;">
        <i data-lucide="table-2" style="color: #6366f1;"></i> 
        PDA Transition Logic
      </h3>
      
      <div style="display: flex; gap: 12px; align-items: center;">
        <button id="pdaExportTableBtn" class="icon-btn" style="background: #eef2ff; border: 1px solid #6366f1; color: #3730a3; font-size: 0.85em; padding: 6px 15px; border-radius: 8px; font-weight: 700;">
            <i data-lucide="download" style="width: 16px;"></i> Export
        </button>
        
        <button id="closePdaLogicModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
      </div>
    </div>
    
    <div style="overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0;">
        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em; text-align: center;">
          <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0;">
            <tr>
              <th style="padding: 12px; text-align: left; color: #475569;">From (Status)</th>
              <th style="padding: 12px; color: #475569;">Input (σ)</th>
              <th style="padding: 12px; color: #475569;">Pop (γ)</th>
              <th style="padding: 12px; text-align: left; color: #475569;">To (Status)</th>
              <th style="padding: 12px; color: #475569;">Push (λ)</th>
              <th style="padding: 12px; color: #475569; width: 60px;">Action</th>
            </tr>
          </thead>
          <tbody id="pdaLogicTableBody" style="color: #1e293b;"></tbody>
        </table>
    </div>
  </div>
</div>

<div id="pdaSaveModal" class="modal-overlay" style="display:none">
    <div class="modal-box" style="width: 400px; border-top: 4px solid #10b981;">
        <h3 style="margin-top:0; color:#064e3b;"><i data-lucide="save"></i> Save PDA Configuration</h3>
        <p style="font-size:0.85em; color:#64748b; margin-bottom:15px;">Configuration will be staged for the Automated Library.</p>
        <div class="modal-prop-row" style="display: flex; align-items: center; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden;">
            <span style="padding: 8px 12px; background: #e2e8f0; color: #475569; font-weight: bold; border-right: 1px solid #cbd5e1; user-select: none;">pda_</span>
            <input id="pdaSaveNameInput" class="modal-input" placeholder="logic-name" style="border: none; flex: 1; padding: 8px; outline: none;">
        </div>
        <div class="modal-actions" style="margin-top:20px;">
            <button onclick="document.getElementById('pdaSaveModal').style.display='none'">Cancel</button>
            <button id="pdaSaveConfirmBtn" class="primary-btn" style="background:#10b981;">Confirm Save</button>
        </div>
    </div>
</div>

<div id="pdaExportPngModal" class="modal-overlay" style="display:none">
    <div class="modal-box" style="width: 400px; border-top: 4px solid #6366f1;">
        <h3 style="margin-top:0; color:#312e81;"><i data-lucide="image"></i> Export High-Res PNG</h3>
        <div class="modal-prop-row" style="display: flex; align-items: center; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden; margin-top: 10px;">
            <span style="padding: 8px 12px; background: #e2e8f0; color: #475569; font-weight: bold; border-right: 1px solid #cbd5e1; user-select: none;">pda_</span>
            <input id="pdaPngNameInput" class="modal-input" placeholder="visual-export" style="border: none; flex: 1; padding: 8px; outline: none;">
        </div>
        <div class="modal-actions" style="margin-top:20px;">
            <button onclick="document.getElementById('pdaExportPngModal').style.display='none'">Cancel</button>
            <button id="pdaPngExportConfirm" class="primary-btn" style="background:#6366f1;">Download PNG</button>
        </div>
    </div>
</div>